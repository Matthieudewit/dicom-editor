<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
        function toggleStudy(id) {
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'none') ? 'block' : 'none';
        }
        
        function deleteStudy(studyName, event) {
            // Prevent the study from toggling when delete button is clicked
            event.stopPropagation();
            
            if (confirm(`Are you sure you want to delete the study "${studyName}"? This action cannot be undone.`)) {
                // Create a form to submit the DELETE request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/delete-study/${encodeURIComponent(studyName)}`;
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</head>

<body>
    <!-- Header with title and utility buttons -->
    <div class="page-header">
        <h2>Select a Study or DICOM File</h2>
        <div class="utility-buttons">
            <a href="{{ url_for('view_logs') }}" class="utility-button logs-button">View Logs</a>
            <a href="{{ url_for('view_settings') }}" class="utility-button settings-button">Settings</a>
        </div>
    </div>
    
    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Button to fetch studies from DICOM service -->
    <div class="dicom-actions">
        <a href="{{ url_for('fetch_dicom_studies') }}" class="fetch-button">Fetch Studies from DICOM Service</a>
        <a href="{{ url_for('load_sample_data') }}" class="load-sample-button">Load Sample Data</a>
    </div>
    
    <!-- Display DICOM service studies if available -->
    {% if dicom_studies %}
    <h3>Studies from DICOM Service</h3>
    {% for study in dicom_studies %}
    <div class="dicom-study-item">
        <div class="study-header">
            <span><strong>{{ study.patient_name }}</strong> - {{ study.study_description }} ({{ study.study_date }})
                <a class="study-download-button" href="{{ url_for('download_study', study_instance_uid=study.study_instance_uid) }}">[Download to Local]</a>
            </span>
        </div>
        <div class="study-details">
            <p>Study Instance UID: {{ study.study_instance_uid }}</p>
            <p>Patient ID: {{ study.patient_id }}</p>
            <p>Accession Number: {{ study.accession_number }}</p>
            <p>Referring Physician: {{ study.referring_physician_name }}</p>
        </div>
    </div>
    {% endfor %}
    {% endif %}
    
    <!-- Local studies section -->
    <h3>Local Studies</h3>
    {% for study, study_data in studies.items() %}
    <div class="study-item" onclick="toggleStudy('study-{{ loop.index }}')">
        <div class="study-header">
            <span>{{ study }} 
                <a class="study-edit-button" href="{{ url_for('edit_study', study=study) }}">[Edit study]</a>
                {% if study_data.is_valid_for_upload %}
                <a class="study-upload-button" href="{{ url_for('upload_study', study=study) }}">[Upload to DICOM]</a>
                {% else %}
                <span class="study-upload-disabled" title="Missing required fields: Study Instance UID, Patient Name, Patient ID, or Accession Number">[Upload to DICOM - Disabled]</span>
                {% endif %}
                <button class="study-delete-button" onclick="deleteStudy('{{ study }}', event)">[Delete]</button>
            </span>
            <!-- <span class="chevron down" id="chevron-{{ study }}">&#9660;</span> -->
        </div>
        
        <!-- Hover tooltip with study metadata -->
        <div class="study-tooltip">
            <div class="tooltip-item">
                <span class="tooltip-label">Study Instance UID:</span>
                <span class="tooltip-value">{{ study_data.metadata.StudyInstanceUID or 'N/A' }}</span>
            </div>
            <div class="tooltip-item">
                <span class="tooltip-label">Patient Name:</span>
                <span class="tooltip-value">{{ study_data.metadata.PatientName or 'N/A' }}</span>
            </div>
            <div class="tooltip-item">
                <span class="tooltip-label">Patient ID:</span>
                <span class="tooltip-value">{{ study_data.metadata.PatientID or 'N/A' }}</span>
            </div>
            <div class="tooltip-item">
                <span class="tooltip-label">Study Description:</span>
                <span class="tooltip-value">{{ study_data.metadata.StudyDescription or 'N/A' }}</span>
            </div>
            <div class="tooltip-item">
                <span class="tooltip-label">Accession Number:</span>
                <span class="tooltip-value">{{ study_data.metadata.AccessionNumber or 'N/A' }}</span>
            </div>
            <div class="tooltip-item">
                <span class="tooltip-label">Referring Physician:</span>
                <span class="tooltip-value">{{ study_data.metadata.ReferringPhysicianName or 'N/A' }}</span>
            </div>
        </div>
        
        <ul id="study-{{ loop.index }}" class="study-files">
            {% for file in study_data.files %}
            <li><a href="{{ url_for('edit_file', file_path=file) }}">{{ file }}</a></li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</body>

</html>